<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>CMU15-445 Fall 2023 Project 4 - SszgwDk</title><meta name=Description content="SszgwDk's Blog"><meta property="og:url" content="https://sszgwdk.github.io/posts/cmu445_p4/">
<meta property="og:site_name" content="SszgwDk"><meta property="og:title" content="CMU15-445 Fall 2023 Project 4"><meta property="og:description" content="23 fall 的 Bustub 引入了 MVCC（多版本并发控制），采用 Hyper MVCC 的方法，即使用类似增量表（delta table）的结构，利用 undo logs（撤销日志）和 Version Chain（版本链）实现并发控制。"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-09-10T11:32:38+08:00"><meta property="article:modified_time" content="2024-09-10T11:32:38+08:00"><meta property="article:tag" content="CMU15-445"><meta property="article:tag" content="DB"><meta property="og:image" content="https://sszgwdk.github.io/lxq.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://sszgwdk.github.io/lxq.jpg"><meta name=twitter:title content="CMU15-445 Fall 2023 Project 4"><meta name=twitter:description content="23 fall 的 Bustub 引入了 MVCC（多版本并发控制），采用 Hyper MVCC 的方法，即使用类似增量表（delta table）的结构，利用 undo logs（撤销日志）和 Version Chain（版本链）实现并发控制。"><meta name=application-name content="LoveIt"><meta name=apple-mobile-web-app-title content="LoveIt"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel=icon href=favicon.svg><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://sszgwdk.github.io/posts/cmu445_p4/><link rel=prev href=https://sszgwdk.github.io/posts/cmu445_p3/><link rel=next href=https://sszgwdk.github.io/posts/cmu445-final120/><link rel=stylesheet href=/css/style.min.e318242ad90f61c3313bdf5cbace1116.css integrity="md5-4xgkKtkPYcMxO99cus4RFg=="><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"CMU15-445 Fall 2023 Project 4","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/sszgwdk.github.io\/posts\/cmu445_p4\/"},"image":[{"@type":"ImageObject","url":"https:\/\/sszgwdk.github.io\/images\/Apple-Devices-Preview.png","width":3200,"height":2048}],"genre":"posts","keywords":"CMU15-445, DB","wordcount":5709,"url":"https:\/\/sszgwdk.github.io\/posts\/cmu445_p4\/","datePublished":"2024-09-10T11:32:38+08:00","dateModified":"2024-09-10T11:32:38+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"xxxx","logo":{"@type":"ImageObject","url":"https:\/\/sszgwdk.github.io\/images\/avatar.png","width":1080,"height":1080}},"author":{"@type":"Person","name":"SszgwDk"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=SszgwDk><img class="lazyload logo" src=/svg/loading.min.svg data-src=/lxq_round.jpg data-srcset="/lxq_round.jpg, /lxq_round.jpg 1.5x, /lxq_round.jpg 2x" data-sizes=auto alt=/lxq_round.jpg title=/lxq_round.jpg>SszgwDk</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>所有文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/about/>关于 </a><a class=menu-item href=https://github.com/dillonzq/LoveIt title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i> </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="menu-item language" title=选择语言><i class="fa fa-globe" aria-hidden=true></i>
<select class=language-select id=language-select-desktop onchange="location=this.value"><option value=/posts/cmu445_p4/ selected>简体中文</option></select></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=SszgwDk><img class="lazyload logo" src=/svg/loading.min.svg data-src=/lxq_round.jpg data-srcset="/lxq_round.jpg, /lxq_round.jpg 1.5x, /lxq_round.jpg 2x" data-sizes=auto alt=/lxq_round.jpg title=/lxq_round.jpg>SszgwDk</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/ title>所有文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=/about/ title>关于</a><a class=menu-item href=https://github.com/dillonzq/LoveIt title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i></a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class=menu-item title=选择语言><i class="fa fa-globe fa-fw" aria-hidden=true></i>
<select class=language-select onchange="location=this.value"><option value=/posts/cmu445_p4/ selected>简体中文</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class="toc-content always-active" id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">CMU15-445 Fall 2023 Project 4</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://sszgwdk.github.io title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>SszgwDk</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/db/><i class="far fa-folder fa-fw" aria-hidden=true></i>DB</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2024-09-10>2024-09-10</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;约 5709 字&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;预计阅读 12 分钟&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#bustub中的hyper-mvcc结构>Bustub中的Hyper MVCC结构</a></li><li><a href=#task1时间戳>Task#1：时间戳</a><ul><li><a href=#11-timestamp-allocation>1.1 Timestamp Allocation</a></li><li><a href=#12-watermark>1.2 Watermark</a></li></ul></li><li><a href=#task2storage-format-and-sequential-scan>Task#2：Storage Format and Sequential Scan</a><ul><li><a href=#reconstructtuple>ReconstructTuple</a></li><li><a href=#sequential-scan--tuple-retrieval>Sequential Scan / Tuple Retrieval</a></li></ul></li><li><a href=#task3mvcc-executors>Task#3：MVCC Executors</a><ul><li><a href=#insert>Insert</a></li><li><a href=#commit>Commit</a></li><li><a href=#update>Update</a></li><li><a href=#delete>Delete</a></li><li><a href=#stop-the-world-garbage-collection>Stop-the-world Garbage Collection</a></li></ul></li><li><a href=#txnmgrdbg>TxnMgrDbg</a></li><li><a href=#task3问题汇总>Task3问题汇总</a><ul><li><a href=#gettuplemeta出错>GetTupleMeta出错</a></li><li><a href=#update-生成的-undo-log-与预期不符>Update 生成的 undo log 与预期不符</a></li></ul></li><li><a href=#task4primary-key-index>Task#4：Primary Key Index</a><ul><li><a href=#index-scan>Index Scan</a></li><li><a href=#41-inserts>4.1 Inserts</a></li></ul></li></ul></nav></div></div><div class=content id=content><p>23 fall 的 Bustub 引入了 MVCC（多版本并发控制），采用 Hyper MVCC 的方法，即使用类似增量表（delta table）的结构，利用 undo logs（撤销日志）和 Version Chain（版本链）实现并发控制。</p><p>Project4 的正确性基于 P1 和 P2，不基于 P3，因为会基于 MVCC 重写 P3 的许多算子。要求至少为事务实现 SNAPSHOT ISOLATION（快照隔离）级别，奖励任务2会要求实现 SERIALIZABLE（可串行化）隔离级别。</p><h2 id=bustub中的hyper-mvcc结构>Bustub中的Hyper MVCC结构</h2><p>​<figure><a class=lightgallery href=/posts/cmu445_p4/image-20240906153613-uk9vdhu.png title=image data-thumbnail=/posts/cmu445_p4/image-20240906153613-uk9vdhu.png data-sub-html="<h2>hyper mvcc</h2><p>image</p>"><img class=lazyload src=/svg/loading.min.svg data-src=/posts/cmu445_p4/image-20240906153613-uk9vdhu.png data-srcset="/posts/cmu445_p4/image-20240906153613-uk9vdhu.png, /posts/cmu445_p4/image-20240906153613-uk9vdhu.png 1.5x, /posts/cmu445_p4/image-20240906153613-uk9vdhu.png 2x" data-sizes=auto alt=/posts/cmu445_p4/image-20240906153613-uk9vdhu.png width=1342 height=413></a><figcaption class=image-caption>hyper mvcc</figcaption></figure>​</p><p>在Bustub中，最新的 Tuple 数据存储在 Table Heap 当中，而旧版本的数据都以撤销日志 undo log 的形式存在各个事务的本地缓冲区中，事务管理器（TxnManager）维护了每个 Tuple 的第一个撤销日志的链接（Versionlink）。对于一个 Tuple 来说，它的 Versionlink + 所有 undo logs 构成了它的版本链。</p><h2 id=task1时间戳>Task#1：时间戳</h2><p>BusTub中所有事务都被分配两个时间戳：</p><ol><li>read timestamp</li><li>commit timestamp</li></ol><p>当事务开始时，将为它分配一个read timestamp，它等于最新提交事务的commit timestamp。在事务提交时，将为其分配一个单调递增的commit timestamp。read timestamp确定事务可以读取哪些数据，commit timestamp确定事务的序列化顺序。</p><h3 id=11-timestamp-allocation>1.1 Timestamp Allocation</h3><p>这部分实现时间戳的分配，一个是在<code>TransactionManager::Begin</code>​中设置一个事务的<code>read_ts_</code>​，一个是在<code>TransactionManager::Commit</code>​中设置事务的<code>commit_ts_</code>​，并为<code>last_commit_ts_</code>​加 1。两个任务都很简单，需要了解 C++ 原子变量<code>atomic</code>​的使用即可。</p><h3 id=12-watermark>1.2 Watermark</h3><p>这个任务要求以 O(logN) 或 O(1) 时间复杂度的算法，维护当前运行事务中的最小<code>read_ts</code>​。我没想到 O(1) 的算法，主要在 Remove 时需要找到现存的次小的 read_ts，感觉难以实现 O(1)。</p><p>所以我采用了 O(logN) 的方法，使用一个map来统计和排序。</p><blockquote><p>回过头来看发现了一个可能的优化方法，在<code>TransactionManager</code>​和测试代码中，调用<code>Watermark::AddTxn(timestamp_t read_ts)</code>​的参数是递增的，也就是不用考虑在AddTxn中排序，直接用一个队列就可以存储这些read_ts，且能够保证单调递增，只需要用一个<code>unordered_map</code>​维护出现次数。在Remove的逻辑中，当某个timestamp的次数减为0时打上懒标记，每次检查队头的ts是否有效，无效则pop直到出现有效的ts，watermark始终是队头的有效read_ts。</p></blockquote><h2 id=task2storage-format-and-sequential-scan>Task#2：Storage Format and Sequential Scan</h2><p>如上面所说，Bustub在三个地方存储事务数据：table heap、transaction manager 和每个 transaction 内部。</p><p>table heap总是包含最新更新的数据，transaction manager中<code>PageVersionInfo</code>​存储指向最新的 undolog 的指针，在每个事务的本地缓冲区中，以 undolog 的格式存储事务修改的元组。</p><p>若要在给定的读取时间戳处检索元组，需要 （1） 获取给定时间戳之后发生的所有修改（又称撤消日志 undo logs），以及 （2） 将修改（undo logs）应用于最新版本的元组，以恢复元组的过去版本。</p><p>​<figure><a class=lightgallery href=/posts/cmu445_p4/image-20240907224059-y5sc4m8.png title=image data-thumbnail=/posts/cmu445_p4/image-20240907224059-y5sc4m8.png data-sub-html="<h2>reconstruct tuple</h2><p>image</p>"><img class=lazyload src=/svg/loading.min.svg data-src=/posts/cmu445_p4/image-20240907224059-y5sc4m8.png data-srcset="/posts/cmu445_p4/image-20240907224059-y5sc4m8.png, /posts/cmu445_p4/image-20240907224059-y5sc4m8.png 1.5x, /posts/cmu445_p4/image-20240907224059-y5sc4m8.png 2x" data-sizes=auto alt=/posts/cmu445_p4/image-20240907224059-y5sc4m8.png width=775 height=257></a><figcaption class=image-caption>reconstruct tuple</figcaption></figure>​</p><h3 id=reconstructtuple>ReconstructTuple</h3><p>​<code>ReconstructTuple</code>​即利用最新的 Tuple 和 undo_logs，恢复出旧版本的 Tuple。它获取存储在table heap中的<code>base_tuple</code>​和<code>base_meta</code>​，以及按添加到系统的时间降序排列的撤消日志列表<code>undo_logs</code>​。</p><p>​<code>ReconstructTuple</code>​始终将提供的所有修改（undo_logs）应用于函数，而无需查看元数据或撤消日志中的时间戳。它不需要访问函数参数列表中提供的数据以外的数据。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=k>struct</span> <span class=nc>UndoLog</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=cm>/* Whether this log is a deletion marker */</span>
</span></span><span class=line><span class=cl>  <span class=kt>bool</span> <span class=n>is_deleted_</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=cm>/* The fields modified by this undo log */</span>
</span></span><span class=line><span class=cl>  <span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>bool</span><span class=o>&gt;</span> <span class=n>modified_fields_</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=cm>/* The modified fields */</span>
</span></span><span class=line><span class=cl>  <span class=n>Tuple</span> <span class=n>tuple_</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=cm>/* Timestamp of this undo log */</span>
</span></span><span class=line><span class=cl>  <span class=n>timestamp_t</span> <span class=n>ts_</span><span class=p>{</span><span class=n>INVALID_TS</span><span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=cm>/* Undo log prev version */</span>
</span></span><span class=line><span class=cl>  <span class=n>UndoLink</span> <span class=n>prev_version_</span><span class=p>{};</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=nc>UndoLink</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=cm>/* Previous version can be found in which txn */</span>
</span></span><span class=line><span class=cl>  <span class=n>txn_id_t</span> <span class=n>prev_txn_</span><span class=p>{</span><span class=n>INVALID_TXN_ID</span><span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=cm>/* The log index of the previous version in `prev_txn_` */</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>prev_log_idx_</span><span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>friend</span> <span class=k>auto</span> <span class=k>operator</span><span class=o>==</span><span class=p>(</span><span class=k>const</span> <span class=n>UndoLink</span> <span class=o>&amp;</span><span class=n>a</span><span class=p>,</span> <span class=k>const</span> <span class=n>UndoLink</span> <span class=o>&amp;</span><span class=n>b</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>a</span><span class=p>.</span><span class=n>prev_txn_</span> <span class=o>==</span> <span class=n>b</span><span class=p>.</span><span class=n>prev_txn_</span> <span class=o>&amp;&amp;</span> <span class=n>a</span><span class=p>.</span><span class=n>prev_log_idx_</span> <span class=o>==</span> <span class=n>b</span><span class=p>.</span><span class=n>prev_log_idx_</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>friend</span> <span class=k>auto</span> <span class=k>operator</span><span class=o>!=</span><span class=p>(</span><span class=k>const</span> <span class=n>UndoLink</span> <span class=o>&amp;</span><span class=n>a</span><span class=p>,</span> <span class=k>const</span> <span class=n>UndoLink</span> <span class=o>&amp;</span><span class=n>b</span><span class=p>)</span> <span class=p>{</span> <span class=k>return</span> <span class=o>!</span><span class=p>(</span><span class=n>a</span> <span class=o>==</span> <span class=n>b</span><span class=p>);</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/* Checks if the undo link points to something. */</span>
</span></span><span class=line><span class=cl>  <span class=k>auto</span> <span class=nf>IsValid</span><span class=p>()</span> <span class=k>const</span> <span class=o>-&gt;</span> <span class=kt>bool</span> <span class=p>{</span> <span class=k>return</span> <span class=n>prev_txn_</span> <span class=o>!=</span> <span class=n>INVALID_TXN_ID</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>undo log中保存了一个部分更新，<code>modified_fields_</code>​是一个长度与表 schema 相等的 bool 向量，若某个 field 为 true，表明对这一列进行了更新。<code>tuple_</code>​存储了部分tuple，若要从元组中检索值，可能需要基于 table schema 和修改后的字段构造元组的<strong>部分schema</strong>。时间戳是此撤消日志对应的读取时间戳。我们还存储了指向下一个撤消日志的链接<code>prev_version_</code>​，如果这是链中的最后一个撤消日志，则 TxnId 将设置为 INVALID_TXN。</p><p>​<code>ReconstructTuple</code>​的实现流程如下：</p><ol><li><p>从<code>base_tuple</code>​中获取每一列的最新的 value，从<code>base_meta</code>​中获取当前的<code>is_deleted</code>​；</p></li><li><p>遍历 undo_logs：</p><ol><li>更新<code>is_deleted</code>​</li><li>根据<code>modified_fields_</code>​和 table schema 构造部分 schema（利用<code>Schema::CopySchema</code>​）</li><li>利用 undo_log 的<code>tuple_</code>​和上一步得到的部分 schema，为需要更新的列重新赋值</li></ol></li><li><p>检验<code>is_deleted</code>​，如果为 true，返回<code>std::nullopt</code>​，否则返回重构后的Tuple</p></li></ol><p>最终返回结果是否存在，取决于最后一个 undo_log 的<code>is_deleted_</code>​，若 undo_log 为空，则取决于 base_meta 的<code>is_deleted_</code>​</p><h3 id=sequential-scan--tuple-retrieval>Sequential Scan / Tuple Retrieval</h3><p>修改project3中实现的 seqscan 算子，根据当前事务的 read_ts 和对应 tuple 的版本链，获取 undo_logs，对 table heap 中最新的 tuple 进行重构。</p><ol><li><p>首先判定 TableHeap 中的 tuple 是否可以直接使用，满足下面两个条件之一：</p><ol><li>tuple的时间戳与当前事务临时时间戳相等</li><li>tuple的时间戳 &lt;= 当前事务的读时间戳</li></ol></li><li><p>若不能直接使用，则需要从 UndoLogs 中重构<code>Reconstruct</code>​</p><ol><li>先获取对应 tuple 到第一个 undo log 的 undo link，如果 undo link 为空说明当前事务读不到该 tuple</li><li>如果不为空则获取<strong>所有满足ts > read_ts的undo_log，以及一个满足ts &lt;= read_ts的undo_log</strong>​</li><li>如果不存在最后一个满足ts &lt;= read_ts的undo_log，则说明读不到这个tuple，跳过</li><li>调用上一个任务实现的<code>ReconstructTuple</code>​进行重构</li></ol></li><li><p>接下来的逻辑与之前 seqscan 相同</p></li></ol><h2 id=task3mvcc-executors>Task#3：MVCC Executors</h2><p>实现 Insert、delete 和 Update 算子。</p><h3 id=insert>Insert</h3><p>这一部分同样是修改 p3 实现的插入算子，不过需要增加的内容很少。</p><ol><li>调用 table heap 的插入接口时带上事务临时时间戳作为Tuple的元数据</li><li>此时没有 undo log，设置 version link 为 null</li><li>将 rid 加入事务的 <strong>write set（在 Commit 阶段有用）</strong></li></ol><h3 id=commit>Commit</h3><blockquote><p>来自文档：</p><p>同一时间只允许一个事务进入<code>Commit</code>​函数，因此要在 transaction manager 使用<code>commit_mutex_</code>​。</p><p>在该任务中，您需要扩展<code>Commit</code>​的在 transaction manager 中的实现：</p><ol><li>获取<code>commit_mutex_</code>​</li><li>获取提交时间戳（但不要增加上次提交的时间戳，因为在提交完成之前，提交时间戳的内容不会稳定）。</li><li>遍历此事务更改的所有元组（使用 write set），将基元组的时间戳设置为提交时间戳。您需要在所有修改执行程序（插入、更新、删除）中维护 write set。</li><li>将事务设置为已提交状态，并更新事务的提交时间戳。</li><li>更新<code>last_committed_ts</code>​.</li></ol></blockquote><p>之前的任务加上已有的代码已经实现了1、2、4、5的步骤，现在只需要实现步骤3，很简单只需要遍历 write set 获取 rid，然后通过 table heap 的接口更新 tuple 的时间戳即可。</p><h3 id=update>Update</h3><p>目前我们的 Inser t算子并没有考虑主键索引，table heap 中当原 Tuple 被删除后就一直保留着，插入操作每次都会写入一个新的位置，因此 Update 操作不会遇到当前 tuple 已被删除以及版本链中有删除日志（<code>is_deleted</code>​字段为 true）的情况，所以要考虑的情况不怎么复杂。</p><p>在获取 update_tuple （更新后的 Tuple）后，执行步骤为：</p><ol><li><p>检测写写冲突：<code>heap_tuple_ts > txn_read_ts && heap_tuple_ts != txn_id</code>​</p><ol><li>当前tuple最新时间戳大于事务读时间戳（当前事务读不到最新数据）并且不等于当前事务时间戳（不是self modification）</li><li>检测出冲突后，直接将事务设置为<code>Tainted</code>​，并抛出异常</li></ol></li><li><p>如果不是self modification（<code>heap_tuple_ts != txn_id</code>​）</p><ol><li>生成新的undo log，<strong>特别注意这个 undo log 包含的数据都是当前 heap_tuple 中被更新的字段数据（即旧数据），并且时间戳也是</strong>​<code>heap_tuple_ts</code>​，而不是当前事务id（要加深对于 undo log 和重构过程的理解）</li><li>将 new undo log 的 prev version 指向当前头部的 undo link</li><li>将 undo link 指向 new undo log</li><li>更新 table heap</li></ol></li><li><p>如果是 self modification，则要分情况讨论：</p><ol><li>如果 Undo link 不为空，说明不是本事务新插入的，但是本事务已经做了修改，已经生成了一个 undo log，但本次 update 可能又更新了几个新字段，此时原来的 undo log 不再适用，要把新字段的旧数据加入进来（undo log 中原有的数据保留不变）</li><li>如果Undo link为空，说明是本事务新插入的，只需要修改 table_heap 即可</li></ol></li><li><p>将目标tuple的rid加入write set</p></li></ol><h3 id=delete>Delete</h3><p>Delete 算子逻辑是类似的，需要注意的是，delete 操作生成的 undo log 要包含旧数据的所有字段。</p><blockquote><p>以上提到的 Update 和 Delete 的逻辑都是较为简单的，因为还没涉及删除标记，目前不会出现 heap_tuple 是删除标记以及 undo log 是删除标记的情况，但是在task4会出现。</p></blockquote><h3 id=stop-the-world-garbage-collection>Stop-the-world Garbage Collection</h3><p>遍历 table_heap 和 version link，记录需要保留的 txn。</p><p>由于 bustub 中的 undo log 管理在事务中，所以垃圾回收也以事务为单位，主要步骤如下：</p><ol><li>遍历txn_map_的所有事务</li><li>遍历当前事务的 write set，从 table heap 中遍历 write set 中的每个记录，如果该事务创建的所有 undo log 均无效，则回收被标记且已提交的事务</li></ol><h2 id=txnmgrdbg>TxnMgrDbg</h2><blockquote><p>来自文档：</p><p>我们建议您实现 execution_common.cpp 中的<code>TxnMgrDbg</code>​函数，用于打印出表堆内容和版本链。我们的测试用例将在每个重要操作后调用你的 debug 函数，你可以打印任何你想要检查版本链的内容。</p></blockquote><p>下面提供一下我的 Debug 函数：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>void</span> <span class=nf>TxnMgrDbg</span><span class=p>(</span><span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=o>&amp;</span><span class=n>info</span><span class=p>,</span> <span class=n>TransactionManager</span> <span class=o>*</span><span class=n>txn_mgr</span><span class=p>,</span> <span class=k>const</span> <span class=n>TableInfo</span> <span class=o>*</span><span class=n>table_info</span><span class=p>,</span>
</span></span><span class=line><span class=cl>               <span class=n>TableHeap</span> <span class=o>*</span><span class=n>table_heap</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// always use stderr for printing logs...
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>fmt</span><span class=o>::</span><span class=n>println</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;debug_hook: {}&#34;</span><span class=p>,</span> <span class=n>info</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// We recommend implementing this function as traversing the table heap and print the version chain. An example output
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// of our reference solution:
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// debug_hook: before verify scan
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// RID=0/0 ts=txn8 tuple=(1, &lt;NULL&gt;, &lt;NULL&gt;)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>//   txn8@0 (2, _, _) ts=1
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// RID=0/1 ts=3 tuple=(3, &lt;NULL&gt;, &lt;NULL&gt;)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>//   txn5@0 &lt;del&gt; ts=2
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>//   txn3@0 (4, &lt;NULL&gt;, &lt;NULL&gt;) ts=1
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// RID=0/2 ts=4 &lt;del marker&gt; tuple=(&lt;NULL&gt;, &lt;NULL&gt;, &lt;NULL&gt;)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>//   txn7@0 (5, &lt;NULL&gt;, &lt;NULL&gt;) ts=3
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// RID=0/3 ts=txn6 &lt;del marker&gt; tuple=(&lt;NULL&gt;, &lt;NULL&gt;, &lt;NULL&gt;)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>//   txn6@0 (6, &lt;NULL&gt;, &lt;NULL&gt;) ts=2
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>//   txn3@1 (7, _, _) ts=1
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>auto</span> <span class=n>tuple_iter</span> <span class=o>=</span> <span class=n>table_heap</span><span class=o>-&gt;</span><span class=n>MakeIterator</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=k>while</span> <span class=p>(</span><span class=o>!</span><span class=n>tuple_iter</span><span class=p>.</span><span class=n>IsEnd</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=k>auto</span> <span class=n>rid</span> <span class=o>=</span> <span class=n>tuple_iter</span><span class=p>.</span><span class=n>GetRID</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>auto</span> <span class=n>tuple_pair</span> <span class=o>=</span> <span class=n>tuple_iter</span><span class=p>.</span><span class=n>GetTuple</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=k>auto</span> <span class=n>tuple</span> <span class=o>=</span> <span class=n>tuple_pair</span><span class=p>.</span><span class=n>second</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=k>auto</span> <span class=n>tuple_meta</span> <span class=o>=</span> <span class=n>tuple_pair</span><span class=p>.</span><span class=n>first</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>++</span><span class=n>tuple_iter</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 先打印table_heap中的元组信息
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>auto</span> <span class=n>ts</span> <span class=o>=</span> <span class=n>tuple_meta</span><span class=p>.</span><span class=n>ts_</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>ts_string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>ts</span> <span class=o>&gt;</span> <span class=n>TXN_START_ID</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>ts</span> <span class=o>=</span> <span class=n>ts</span> <span class=o>-</span> <span class=n>TXN_START_ID</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>ts_string</span> <span class=o>=</span> <span class=n>fmt</span><span class=o>::</span><span class=n>format</span><span class=p>(</span><span class=s>&#34;txn{}&#34;</span><span class=p>,</span> <span class=n>ts</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>ts_string</span> <span class=o>=</span> <span class=n>fmt</span><span class=o>::</span><span class=n>format</span><span class=p>(</span><span class=s>&#34;{}&#34;</span><span class=p>,</span> <span class=n>ts</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>tuple_meta</span><span class=p>.</span><span class=n>is_deleted_</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>fmt</span><span class=o>::</span><span class=n>println</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;RID={}/{} ts={} &lt;del marker&gt; tuple={}&#34;</span><span class=p>,</span> <span class=n>rid</span><span class=p>.</span><span class=n>GetPageId</span><span class=p>(),</span> <span class=n>rid</span><span class=p>.</span><span class=n>GetSlotNum</span><span class=p>(),</span> <span class=n>ts_string</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                   <span class=n>tuple</span><span class=p>.</span><span class=n>ToString</span><span class=p>(</span><span class=o>&amp;</span><span class=n>table_info</span><span class=o>-&gt;</span><span class=n>schema_</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>fmt</span><span class=o>::</span><span class=n>println</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;RID={}/{} ts={} tuple={}&#34;</span><span class=p>,</span> <span class=n>rid</span><span class=p>.</span><span class=n>GetPageId</span><span class=p>(),</span> <span class=n>rid</span><span class=p>.</span><span class=n>GetSlotNum</span><span class=p>(),</span> <span class=n>ts_string</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                   <span class=n>tuple</span><span class=p>.</span><span class=n>ToString</span><span class=p>(</span><span class=o>&amp;</span><span class=n>table_info</span><span class=o>-&gt;</span><span class=n>schema_</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 打印version chain
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// auto version_link = txn_mgr-&gt;GetVersionLink(rid);
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>auto</span> <span class=n>undo_link</span> <span class=o>=</span> <span class=n>txn_mgr</span><span class=o>-&gt;</span><span class=n>GetUndoLink</span><span class=p>(</span><span class=n>rid</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>undo_link</span><span class=p>.</span><span class=n>has_value</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>auto</span> <span class=n>link</span> <span class=o>=</span> <span class=n>undo_link</span><span class=p>.</span><span class=n>value</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=k>while</span> <span class=p>(</span><span class=n>link</span><span class=p>.</span><span class=n>IsValid</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 有可能事务被GC
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>auto</span> <span class=n>undo_log_opt</span> <span class=o>=</span> <span class=n>txn_mgr</span><span class=o>-&gt;</span><span class=n>GetUndoLogOptional</span><span class=p>(</span><span class=n>link</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>undo_log_opt</span><span class=p>.</span><span class=n>has_value</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>auto</span> <span class=n>undo_log</span> <span class=o>=</span> <span class=n>undo_log_opt</span><span class=p>.</span><span class=n>value</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>auto</span> <span class=n>txn_id</span> <span class=o>=</span> <span class=n>link</span><span class=p>.</span><span class=n>prev_txn_</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>txn_id</span> <span class=o>&gt;</span> <span class=n>TXN_START_ID</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>txn_id</span> <span class=o>=</span> <span class=n>txn_id</span> <span class=o>-</span> <span class=n>TXN_START_ID</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>undo_log</span><span class=p>.</span><span class=n>is_deleted_</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>fmt</span><span class=o>::</span><span class=n>print</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;  txn{}@{} &lt;del&gt; ts={}</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>txn_id</span><span class=p>,</span> <span class=n>link</span><span class=p>.</span><span class=n>prev_log_idx_</span><span class=p>,</span> <span class=n>undo_log</span><span class=p>.</span><span class=n>ts_</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 构建Undolog的tuple schema
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>uint32_t</span><span class=o>&gt;</span> <span class=n>modified_cols</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=k>for</span> <span class=p>(</span><span class=kt>uint32_t</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>undo_log</span><span class=p>.</span><span class=n>modified_fields_</span><span class=p>.</span><span class=n>size</span><span class=p>();</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>undo_log</span><span class=p>.</span><span class=n>modified_fields_</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=n>modified_cols</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=n>Schema</span> <span class=n>undo_schema</span> <span class=o>=</span> <span class=n>Schema</span><span class=o>::</span><span class=n>CopySchema</span><span class=p>(</span><span class=o>&amp;</span><span class=n>table_info</span><span class=o>-&gt;</span><span class=n>schema_</span><span class=p>,</span> <span class=n>modified_cols</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=n>fmt</span><span class=o>::</span><span class=n>print</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;  txn{}@{} {} ts={}</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>txn_id</span><span class=p>,</span> <span class=n>link</span><span class=p>.</span><span class=n>prev_log_idx_</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                     <span class=n>undo_log</span><span class=p>.</span><span class=n>tuple_</span><span class=p>.</span><span class=n>ToString</span><span class=p>(</span><span class=o>&amp;</span><span class=n>undo_schema</span><span class=p>),</span> <span class=n>undo_log</span><span class=p>.</span><span class=n>ts_</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>link</span> <span class=o>=</span> <span class=n>undo_log</span><span class=p>.</span><span class=n>prev_version_</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>‍</p><h2 id=task3问题汇总>Task3问题汇总</h2><h3 id=gettuplemeta出错>GetTupleMeta出错</h3><p>​<figure><a class=lightgallery href=/posts/cmu445_p4/image-20240908111136-ywnz9hm.png title=image data-thumbnail=/posts/cmu445_p4/image-20240908111136-ywnz9hm.png data-sub-html="<h2>GetTupleMeta出错</h2><p>image</p>"><img class=lazyload src=/svg/loading.min.svg data-src=/posts/cmu445_p4/image-20240908111136-ywnz9hm.png data-srcset="/posts/cmu445_p4/image-20240908111136-ywnz9hm.png, /posts/cmu445_p4/image-20240908111136-ywnz9hm.png 1.5x, /posts/cmu445_p4/image-20240908111136-ywnz9hm.png 2x" data-sizes=auto alt=/posts/cmu445_p4/image-20240908111136-ywnz9hm.png width=1642 height=316></a><figcaption class=image-caption>GetTupleMeta出错</figcaption></figure>​</p><p>​<figure><a class=lightgallery href=/posts/cmu445_p4/image-20240908111138-0ip07jm.png title=image data-thumbnail=/posts/cmu445_p4/image-20240908111138-0ip07jm.png data-sub-html="<h2>出错代码</h2><p>image</p>"><img class=lazyload src=/svg/loading.min.svg data-src=/posts/cmu445_p4/image-20240908111138-0ip07jm.png data-srcset="/posts/cmu445_p4/image-20240908111138-0ip07jm.png, /posts/cmu445_p4/image-20240908111138-0ip07jm.png 1.5x, /posts/cmu445_p4/image-20240908111138-0ip07jm.png 2x" data-sizes=auto alt=/posts/cmu445_p4/image-20240908111138-0ip07jm.png width=1064 height=267></a><figcaption class=image-caption>出错代码</figcaption></figure>​</p><blockquote><p>感觉这是一个巨坑！</p></blockquote><p>在插入算子中，调用<code>auto new_rid = table_info->table_->InsertTuple(TupleMeta{transaction_tmp_ts_, false}, todo_tuple);</code>​<strong>不会把</strong>​<code>new_rid</code>​<strong>存到 todo_tuple 当中去，所以不能通过</strong>​<code>tuple.GetRid()</code>​获取 Tuple 的 Rid。</p><p>所以在其他算子中，例如 seqScan 算子，得到的 tuple 的 rid 都是空的。进而到 delete 算子、update算子中如果通过<code>tuple->GetRid()</code>​访问 table_heap_，会造成空指针访问。</p><p>解决方法：在 seqScan 算子中返回 tuple 和 rid 时，<code>tuple->SetRid(rid)</code>​。</p><h3 id=update-生成的-undo-log-与预期不符>Update 生成的 undo log 与预期不符</h3><p>​<figure><a class=lightgallery href=/posts/cmu445_p4/image-20240908124854-wwyssd8.png title=image data-thumbnail=/posts/cmu445_p4/image-20240908124854-wwyssd8.png data-sub-html="<h2>错误日志</h2><p>image</p>"><img class=lazyload src=/svg/loading.min.svg data-src=/posts/cmu445_p4/image-20240908124854-wwyssd8.png data-srcset="/posts/cmu445_p4/image-20240908124854-wwyssd8.png, /posts/cmu445_p4/image-20240908124854-wwyssd8.png 1.5x, /posts/cmu445_p4/image-20240908124854-wwyssd8.png 2x" data-sizes=auto alt=/posts/cmu445_p4/image-20240908124854-wwyssd8.png width=903 height=618></a><figcaption class=image-caption>错误日志</figcaption></figure>​</p><p>原因：在 self_modification 的情况下，当构造新的 undo log 时，应该保持 undo log 原有的数据不被修改，当列值有所更新时，不一定要更新数据，因为可能之前已经更新了，已经保存了原始的旧数据。</p><p>解决：此时要检查<code>modified_fields[i]</code>​，如果之前没有更新，再在undo_log中记录。即：</p><p>​<code>if (!old_value.CompareExactlyEquals(new_value) && modified_fields[i] == false)</code>​</p><p>​<figure><a class=lightgallery href=/posts/cmu445_p4/image-20240908125146-dlh5755.png title=image data-thumbnail=/posts/cmu445_p4/image-20240908125146-dlh5755.png data-sub-html="<h2>检查modified_fields</h2><p>image</p>"><img class=lazyload src=/svg/loading.min.svg data-src=/posts/cmu445_p4/image-20240908125146-dlh5755.png data-srcset="/posts/cmu445_p4/image-20240908125146-dlh5755.png, /posts/cmu445_p4/image-20240908125146-dlh5755.png 1.5x, /posts/cmu445_p4/image-20240908125146-dlh5755.png 2x" data-sizes=auto alt=/posts/cmu445_p4/image-20240908125146-dlh5755.png width=960 height=277></a><figcaption class=image-caption>检查modified_fields</figcaption></figure>​</p><h2 id=task4primary-key-index>Task#4：Primary Key Index</h2><p>BusTub 支持主键索引，可以通过以下方式创建主键索引:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>CREATE TABLE t1(v1 int PRIMARY KEY);
</span></span><span class=line><span class=cl>CREATE TABLE t1(v1 int, v2 int, PRIMARY KEY(v1, v2));
</span></span></code></pre></td></tr></table></div></div><p>当一个 table 创建时指定了主键，bustub会自动创建一个索引（<code>is_primary_key</code>​为true）。一个表最多有一个主键索引。主键索引确保主键的唯一性。在此任务中需要处理算子中的主键索引。测试案例中不会通过<code>CREATE INDEX</code>​创建二级索引，因此在该任务中不需要维护二级索引。</p><h3 id=index-scan>Index Scan</h3><p>此时无需实现 MVCC Index Scan 算子。这适用于任务 4.2 及之后的任务。测试用例将使用范围查询而不是相等查询，以避免调用 IndexScan 算子，以便在实现 4.1 时不会将顺序扫描转换为索引扫描。</p><h3 id=41-inserts>4.1 Inserts</h3><p>文档里面写得很详细：</p><p>您将需要修改插入执行程序以正确处理主键索引。同时，您还需要考虑多个事务在多个线程中插入同一主键的情况。可以使用索引进行插入，请执行以下步骤：</p><ol><li><p>首先检查 tuple 是否已经在索引中存在（通过索引的<code>ScanKey</code>​接口查询），如果存在，终止当前事务</p><ol><li>这仅适用于 4.1。如果要实现 4.2，则索引可能指向已删除的元组，在这种情况下，不应中止。</li><li>你只需要将事务状态设置为<code>TAINTED</code>​。<code>TAINTED</code>​表示事务即将中止，但数据尚未清理。您不需要实现实际的 Abort 过程。受污染的事务会在表堆中留下一些元组，您不需要清理它。当另一个事务插入到同一位置并检测到写入冲突时，由于元组未被清理，因此仍应将其视为冲突。</li><li>设置事务状态之后，你还需要抛出一个 ExecutionException。</li></ol></li><li><p>在 table heap 创建一个tuple（时间戳为 txn_id）</p></li><li><p>之后，将元组插入索引中。如果违反唯一键约束，则哈希索引应返回 false（通过索引的<code>InsertEntry</code>​接口检测冲突）。在（1）和（3）之间，其他事务可能正在执行相同的操作，并且在当前事务创建新条目之前，会在索引中创建一个新条目。在这种情况下，您将需要中止事务，并且表堆中将有一个元组，该元组不被索引中的任何条目指向。</p></li></ol><p>其他环节与 Task3 中保持不变。</p><p>完成 4.1 及之前的所有任务已经能够获得 80 分了，此时只有一个并发插入的测试用例。后续的任务需要再次重构算子，难度较大，内容较多，我将在下一篇文章中整理当时实现的思路和遇到的问题。</p><p>‍</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2024-09-10</span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/posts/cmu445_p4/index.md target=_blank>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://sszgwdk.github.io/posts/cmu445_p4/ data-title="CMU15-445 Fall 2023 Project 4" data-hashtags=CMU15-445,DB><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://sszgwdk.github.io/posts/cmu445_p4/ data-hashtag=CMU15-445><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Hacker News" data-sharer=hackernews data-url=https://sszgwdk.github.io/posts/cmu445_p4/ data-title="CMU15-445 Fall 2023 Project 4"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://sszgwdk.github.io/posts/cmu445_p4/ data-title="CMU15-445 Fall 2023 Project 4"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://sszgwdk.github.io/posts/cmu445_p4/ data-title="CMU15-445 Fall 2023 Project 4"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/cmu15-445/>CMU15-445</a>,&nbsp;<a href=/tags/db/>DB</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/cmu445_p3/ class=prev rel=prev title="CMU15-445 Fall 2023 Project 3"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>CMU15-445 Fall 2023 Project 3</a>
<a href=/posts/cmu445-final120/ class=next rel=next title="CMU15-445 Fall 2023 Task4.2, 4.3 及奖励任务">CMU15-445 Fall 2023 Task4.2, 4.3 及奖励任务<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=disqus_thread class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://disqus.com/?ref_noscript>Disqus</a>.</noscript><div id=giscus class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app>Giscus</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><span id=run-time></span></div><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.134.1">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2024</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>SszgwDk</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><section><span id=busuanzi_container_value_site_pv><i class="far fa-eye fa-fw"></i>
<span id=busuanzi_value_site_pv></span>
</span>&nbsp;|&nbsp;
<span id=busuanzi_container_value_site_uv><i class="fa fa-user"></i>
<span id=busuanzi_value_site_uv></span></span></section></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/css/lightgallery-bundle.min.css><script type=text/javascript src=https://.disqus.com/embed.js defer></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=/lib/lunr/lunr.stemmer.support.min.ed0a27121ddab004060c9428cdccae61.js integrity="md5-7QonEh3asAQGDJQozcyuYQ=="></script><script type=text/javascript src=/lib/lunr/lunr.zh.min.5e892728c8a115cebb72cc4d8b9e8eba.js integrity="md5-XoknKMihFc67csxNi56Oug=="></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/lightgallery.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/thumbnail/lg-thumbnail.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/zoom/lg-zoom.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:50},comment:{giscus:{category:"Announcements",categoryId:"DIC_kwDOMj6qS84ChrG6",darkTheme:"dark",emitMetadata:"0",inputPosition:"bottom",lang:"zh-CN",lazyLoading:!1,lightTheme:"light",mapping:"pathname",reactionsEnabled:"1",repo:"sszgwdk/comment",repoId:"R_kgDOMj6qSw"}},lightgallery:!0,search:{highlightTag:"em",lunrIndexURL:"/index.json",lunrLanguageCode:"zh",lunrSegmentitURL:"/lib/lunr/lunr.segmentit.js",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.11ec27a93928e59f850531b2018d00bf.js integrity="md5-EewnqTko5Z+FBTGyAY0Avw=="></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/jquery@2.1.3/dist/jquery.min.js></script><script type=text/javascript src=/js/custom.js></script></body></html>